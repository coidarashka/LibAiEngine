name: Build AiEngine â†’ Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  NDK_VERSION: r26b
  NDK_HOME: ${{ github.workspace }}/../android-ndk
  PROJ: ${{ github.workspace }}

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake git wget unzip python3 binutils

      - name: Cache NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/../android-ndk
          key: android-ndk-${{ env.NDK_VERSION }}

      - name: Install NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          cd ${{ github.workspace }}/..
          wget -q https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip
          unzip -q android-ndk-${NDK_VERSION}-linux.zip
          mv android-ndk-${NDK_VERSION} android-ndk
          rm android-ndk-${NDK_VERSION}-linux.zip

      - name: Remove dynamic libomp
        run: |
          find $NDK_HOME -name "libomp.so" -delete
          find $NDK_HOME -name "libomp.so.*" -delete

      - name: Clone deps
        run: |
          mkdir -p $PROJ/miniaudio $PROJ/stb
          git clone --depth 1 https://github.com/ggerganov/llama.cpp.git $PROJ/llama.cpp
          git clone --depth 1 https://github.com/nlohmann/json.git $PROJ/json
          git clone --depth 1 https://github.com/ARM-software/kleidiai.git $PROJ/kleidiai_source
          wget -q https://raw.githubusercontent.com/mackron/miniaudio/master/miniaudio.h -O $PROJ/miniaudio/miniaudio.h
          wget -q https://raw.githubusercontent.com/nothings/stb/master/stb_image.h -O $PROJ/stb/stb_image.h
          wget -q https://raw.githubusercontent.com/nothings/stb/master/stb_image_write.h -O $PROJ/stb/stb_image_write.h

      - name: Build
        run: |
          mkdir -p $PROJ/build && cd $PROJ/build
          cmake .. \
            -DCMAKE_TOOLCHAIN_FILE=$NDK_HOME/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-29 \
            -DANDROID_STL=c++_static \
            -DGGML_OPENMP=ON \
            -DGGML_FLASH_ATTN=ON \
            -DGGML_CPU_KLEIDIAI=ON \
            -DFETCHCONTENT_SOURCE_DIR_KLEIDIAI_DOWNLOAD=$PROJ/kleidiai_source \
            -DBUILD_SHARED_LIBS=OFF \
            -DNDK_HOME=$NDK_HOME
          make -j$(nproc) AiEngine

      - name: Verify no dynamic libomp
        run: |
          READELF=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-readelf
          $READELF -d $PROJ/build/libAiEngine.so | grep "libomp.so" && exit 1 || true

      - name: Package
        run: |
          mkdir -p $PROJ/dist
          cp $PROJ/build/libAiEngine.so $PROJ/dist/
          cd $PROJ/dist && zip libAiEngine-arm64-v8a.zip libAiEngine.so

      - uses: actions/upload-artifact@v4
        with:
          name: libAiEngine-arm64-v8a
          path: ${{ github.workspace }}/dist/libAiEngine-arm64-v8a.zip
          retention-days: 14

      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          name: "AiEngine ${{ github.ref_name }}"
          tag_name: ${{ github.ref_name }}
          body: |
            | File | ABI | NDK | OpenMP |
            |------|-----|-----|--------|
            | `libAiEngine.so` | arm64-v8a | r26b | static |
          files: ${{ github.workspace }}/dist/libAiEngine-arm64-v8a.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
